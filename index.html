<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Supervis√£o Ambiental ‚Äì CEDAE</title>

  <meta name="description" content="Sistema de Supervis√£o Ambiental da CEDAE - Gerenciamento de vistorias t√©cnicas, PGE e acidentes ambientais.">

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="DMA">

  <link rel="manifest" href="manifest.json">

  <link rel="preload" href="lib/tailwind.js" as="script">
  <link rel="preload" href="lib/exceljs.min.js" as="script">

  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="icon.png">

  <meta name="theme-color" content="#0067ac">

  <style>
    :root { --blue-cedae: #0067ac; }
    body {
      margin: 0;
      padding-top: env(safe-area-inset-top);
      background: #ffffff;
      font-family: sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    .hidden { display: none !important; }
    input, select, button { border-radius: 16px; min-height: 56px; width: 100%; }

    /* P√≠lula de Conex√£o Discreta */
    #connection-pill {
      position: fixed;
      top: calc(env(safe-area-inset-top) + 12px);
      left: 50%;
      transform: translateX(-50%);
      border-radius: 50px;
      padding: 6px 16px;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.03);
      transition: all 0.5s ease;
    }
    .dot { width: 8px; height: 8px; border-radius: 50%; }
    .animate-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Acessibilidade */
    .sr-only {
      position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0, 0, 0, 0); border: 0;
    }
  </style>
</head>

<body class="text-gray-900 overflow-x-hidden">
  <main>
    <div id="connection-pill" role="status" aria-live="polite">
      <span id="connection-dot" class="dot bg-gray-400"></span>
      <span id="connection-text" class="text-[9px] font-black uppercase tracking-tighter text-gray-500">Verificando...</span>
    </div>

    <section id="screen-cadastro" class="max-w-xl mx-auto min-h-screen flex flex-col p-6 pt-24 animate-in">
      <div class="text-center mb-8">
        <img src="icon.png" width="160" height="64" class="h-16 w-full object-contain mx-auto mb-4" alt="Logotipo CEDAE">
        <h1 class="text-2xl font-black text-[#0067ac]">VISTORIA T√âCNICA</h1>
        <p class="text-[#0067ac] text-[10px] font-bold tracking-widest uppercase">Supervis√£o Ambiental</p>
      </div>

      <div class="space-y-4 mb-6 bg-white p-2 rounded-3xl">
        <label for="avaliador" class="sr-only">Nome do Avaliador</label>
        <input id="avaliador" type="text" placeholder="Nome do Avaliador"
               class="bg-gray-50 px-4 border-none outline-none focus:ring-2 focus:ring-blue-100">

        <label for="local" class="sr-only">Local da Vistoria</label>
        <select id="local" class="bg-gray-50 px-4 border-none outline-none"></select>

        <div class="grid grid-cols-2 gap-3">
          <label for="data_visita" class="sr-only">Data da Visita</label>
          <!-- tailwind padr√£o n√£o tem bg-gray-60 -->
          <input id="data_visita" type="date" class="bg-gray-50 px-4 text-sm border-none outline-none">

          <label for="colaborador" class="sr-only">Nome do Acompanhante</label>
          <input id="colaborador" type="text" placeholder="Acompanhante"
                 class="bg-gray-50 px-4 text-sm border-none outline-none">
        </div>

        <button type="button" onclick="validarEComecar()"
                class="bg-[#0067ac] text-white font-bold shadow-lg active:scale-95 transition-all">
          INICIAR AGORA
        </button>
      </div>

      <div class="p-5 bg-slate-50 rounded-[2rem] border border-slate-100 mb-8">
        <h2 class="text-slate-500 font-black text-[10px] uppercase mb-2 flex items-center gap-2">
          <span aria-hidden="true">üõ°Ô∏è</span> Nota de Seguran√ßa
        </h2>
        <p class="text-[11px] leading-relaxed text-slate-500">
          O sinal de internet pode oscilar no local, mas isso <b>n√£o interfere</b> no seu trabalho.
          Os dados s√£o salvos no seu aparelho. Apenas lembre-se de <b>baixar o Excel</b> ao concluir cada visita.
        </p>
      </div>
    </section>

    <section id="screen-select-roteiro" class="max-w-xl mx-auto hidden min-h-screen flex flex-col justify-center p-6 space-y-4 animate-in">
      <h2 class="text-[#0067ac] font-black text-center text-xl mb-6 uppercase">Escolha o Formul√°rio</h2>

      <button type="button" onclick="selectRoteiro('geral')"
              class="p-6 bg-white shadow-md border-l-[10px] border-green-500 flex flex-col items-start justify-center text-left">
        <span class="text-[10px] font-bold text-gray-400">OP√á√ÉO 01</span>
        <span class="text-green-600 font-black text-lg">FORMUL√ÅRIO GERAL</span>
      </button>

      <button type="button" onclick="selectRoteiro('pge')"
              class="p-6 bg-white shadow-md border-l-[10px] border-[#0067ac] flex flex-col items-start justify-center text-left">
        <span class="text-[10px] font-bold text-gray-400">OP√á√ÉO 02</span>
        <span class="text-[#0067ac] font-black text-lg leading-tight uppercase">Gerenciamento de Efluentes (PGE)</span>
      </button>

      <button type="button" onclick="selectRoteiro('aa')"
              class="p-6 bg-white shadow-md border-l-[10px] border-red-500 flex flex-col items-start justify-center text-left">
        <span class="text-[10px] font-bold text-gray-400">OP√á√ÉO 03</span>
        <span class="text-red-600 font-black text-lg">ACIDENTES AMBIENTAIS</span>
      </button>
    </section>

    <section id="screen-formulario" class="max-w-3xl mx-auto hidden pb-40 p-4">
      <div class="sticky top-4 bg-white/95 backdrop-blur-md z-40 border shadow-lg mb-6 p-4 rounded-3xl">
        <div class="flex justify-between items-center mb-3">
          <button type="button" onclick="showScreen('screen-select-roteiro')"
                  class="!min-h-0 py-2 px-4 rounded-full text-gray-500 text-[10px] font-bold w-auto bg-gray-100">
            ‚Üê MUDAR
          </button>
          <span id="roteiro-atual-label"
                class="text-[9px] font-black bg-blue-100 text-blue-700 px-3 py-1 rounded-full uppercase tracking-tighter">...</span>
        </div>

        <div id="sublocal_box" class="hidden mb-2">
          <label for="sublocal_select" class="sr-only">Selecione o Sublocal</label>
          <select id="sublocal_select" class="border-blue-200 bg-blue-50/50 font-bold text-[#0067ac]"></select>
        </div>

        <div id="secao_box">
          <label for="secao_select" class="sr-only">Selecione a Se√ß√£o</label>
          <select id="secao_select" class="border-gray-200 font-bold text-gray-600"></select>
        </div>
      </div>

      <div id="conteudo_formulario" class="space-y-6"></div>

      <div class="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-white via-white/80 to-transparent z-50">
        <button type="button" onclick="showScreen('screen-final')"
                class="bg-green-600 text-white shadow-xl font-bold active:scale-95 transition-all">
          CONCLUIR VISTORIA
        </button>
      </div>
    </section>

    <section id="screen-final" class="max-w-xl mx-auto hidden min-h-screen flex flex-col justify-center p-6 text-center animate-in">
      <div class="bg-white p-8 rounded-[3rem] shadow-2xl border border-gray-50">
        <div id="status-icon-circle"
             class="w-20 h-20 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mx-auto mb-4 transition-all duration-500">
          <span id="status-icon-symbol" class="text-4xl" aria-hidden="true">‚è≥</span>
        </div>

        <h2 id="status-final-title" class="text-2xl font-black text-gray-800 mb-1 uppercase tracking-tight leading-none">Vistoria Salva!</h2>
        <p id="status-final-text" class="text-gray-400 text-[11px] mb-8">Os dados est√£o seguros no seu aparelho.</p>

        <div class="space-y-3">
          <button type="button" onclick="handleSincronizacao()" id="btn-sync"
                  class="bg-[#0067ac] text-white font-bold active:scale-95 transition-all flex items-center justify-center gap-2">
            <span id="sync-spinner" class="hidden animate-spin">üåÄ</span>
            <span id="sync-text">ENVIAR PARA O SERVIDOR ‚òÅÔ∏è</span>
          </button>

          <button type="button" onclick="baixarExcelConsolidado()" id="btn-excel"
                  class="bg-emerald-600 text-white font-bold active:scale-95 transition-all flex items-center justify-center gap-2">
            <span id="excel-spinner" class="hidden animate-spin">‚è≥</span>
            <span id="excel-text">BAIXAR RELAT√ìRIO EXCEL üìä</span>
          </button>

          <p id="status-sinc" class="text-[10px] text-gray-400 pt-2">Aguardando...</p>

          <div class="pt-4 space-y-2">
            <button type="button" onclick="showScreen('screen-formulario')"
                    class="!min-h-0 py-3 text-[#0067ac] font-bold text-xs">
              ‚Üê EDITAR RESPOSTAS
            </button>

            <hr class="border-gray-100">

            <button type="button" onclick="window.confirmarNovaVistoria && window.confirmarNovaVistoria()"
                    class="!min-h-0 py-2 text-gray-500 text-[10px] font-black uppercase tracking-widest bg-transparent">
              Iniciar Outra Vistoria
            </button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- SCRIPTS (ordem importa) -->
  <script src="lib/tailwind.js" defer></script>
  <script src="lib/exceljs.min.js" defer></script>
  <script src="roteiros.js" defer></script>
  <script src="camera.js" defer></script>
  <script src="indexedDB.js" defer></script>
  <script src="sync_manager.js" defer></script>
  <script src="app.js" defer></script>

  <script>
    function atualizarRede() {
      const dot = document.getElementById('connection-dot');
      const texto = document.getElementById('connection-text');
      if (!dot || !texto) return;

      if (navigator.onLine) {
        dot.className = "dot bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.4)]";
        texto.innerText = "Sinal Online";
        texto.classList.remove('text-orange-700');
        texto.classList.add('text-green-700');
      } else {
        dot.className = "dot bg-yellow-400 shadow-[0_0_8px_rgba(250,204,21,0.4)] animate-pulse";
        texto.innerText = "Sinal Fraco / Local";
        texto.classList.remove('text-green-700');
        texto.classList.add('text-orange-700');
      }
    }
    window.addEventListener('online', atualizarRede);
    window.addEventListener('offline', atualizarRede);
    atualizarRede();

    // Service Worker: deixe s√≥ aqui (recomendado) OU s√≥ no app.js (n√£o nos dois)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(() => console.log('[PWA] Service Worker registrado.'))
          .catch((err) => console.warn('[PWA] Falha ao registrar SW:', err));
      });
    }
  </script>
</body>
</html>
